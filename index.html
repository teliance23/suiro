<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suirodoku.com</title>
    
    <!-- FAVICON -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHP3A6BZXAx72fY0_BFJQe9y1F2Za_Xo8",
            authDomain: "suirodoku-web.firebaseapp.com",
            projectId: "suirodoku-web",
            storageBucket: "suirodoku-web.firebasestorage.app",
            messagingSenderId: "936879624195",
            appId: "1:936879624195:web:e3d2682df7c9b213d87e36",
            measurementId: "G-RPJXTCGLZN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase functions globally available
        window.firebaseAuth = {
            auth,
            db,
            onAuthStateChanged,
            signOut,
            doc,
            getDoc,
            setDoc,
            updateDoc
        };

        // ============= FONCTIONS GLOBALES DE PROFIL =============
        
        // Fonction pour obtenir le nom d'affichage selon les pr√©f√©rences
        window.getDisplayName = function(userData) {
            if (userData.profile?.displayPreference === 'gamertag' && userData.profile?.gamertag) {
                return userData.profile.gamertag;
            }
            return userData.displayName || 'Anonymous';
        };

        // Fonction pour obtenir le drapeau selon la nationalit√©
        window.getFlagEmoji = function(countryCode) {
            const flags = {
                'FR': 'üá´üá∑', 'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'DE': 'üá©üá™', 'ES': 'üá™üá∏',
                'IT': 'üáÆüáπ', 'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'BR': 'üáßüá∑', 'CA': 'üá®üá¶',
                'AU': 'üá¶üá∫', 'IN': 'üáÆüá≥', 'RU': 'üá∑üá∫', 'MX': 'üá≤üáΩ', 'KR': 'üá∞üá∑',
                'NL': 'üá≥üá±', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥', 'DK': 'üá©üá∞', 'FI': 'üá´üáÆ',
                'CH': 'üá®üá≠', 'AT': 'üá¶üáπ', 'BE': 'üáßüá™', 'PL': 'üáµüá±', 'PT': 'üáµüáπ'
            };
            return flags[countryCode] || 'üåç';
        };

        // Fonction pour v√©rifier si le profil est complet
        window.isProfileComplete = function(userData) {
            return userData.profile?.isProfileComplete === true;
        };

        // Fonction pour r√©cup√©rer les donn√©es utilisateur compl√®tes
        window.getUserData = async function(user) {
            try {
                const userRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    return { ...user, ...userDoc.data() };
                }
                return user;
            } catch (error) {
                console.error('Error fetching user data:', error);
                return user;
            }
        };

        // ============= FONCTIONS FIREBASE UNIVERSELLES POUR LES STATISTIQUES =============
        
        // ‚ö° NOUVELLE FONCTION : Mettre √† jour les stats pour TOUS les modes
        window.updatePlayerStatsUniversal = async function(gameData) {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('User not authenticated');
                }

                console.log('üéÆ Updating universal player stats with data:', gameData);
                
                // Appeler directement la fonction de mise √† jour des stats
                await updatePlayerStatsForAllModes(user.uid, gameData);
                console.log(`‚úÖ Universal player stats updated for ${gameData.gameMode} game:`, {
                    difficulty: gameData.difficulty,
                    time: gameData.time,
                    score: gameData.finalScore,
                    endType: gameData.endType,
                    completed: gameData.isCompleted
                });
                
            } catch (error) {
                console.error('‚ùå Error updating universal player stats:', error);
                throw error;
            }
        };

        // ‚ö° NOUVELLE FONCTION : R√©cup√©rer les stats d'un joueur (universelle)
        window.getPlayerStats = async function(userId) {
            try {
                if (!userId) return null;
                
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    return userData.gameStats || null;
                } else {
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error getting player stats:', error);
                return null;
            }
        };

        // ‚ö° NOUVELLE FONCTION : Mettre √† jour les stats pour tous les modes (practice + ranked)
        async function updatePlayerStatsForAllModes(userId, gameData) {
            try {
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                let currentStats = {
                    totalGamesPlayed: 0,
                    totalGamesWon: 0,
                    totalTimeSpent: 0,
                    averageTime: 0,
                    averageScore: 0,
                    bestScores: {},
                    practiceGames: 0,
                    rankedGames: 0,
                    level: 'Beginner',
                    currentPerformance: 0,
                    lastPlayed: new Date(),
                    // ‚ö° NOUVEAU : Compteurs par type de fin
                    gamesCompleted: 0,
                    gamesAbandoned: 0,
                    gamesDefeated: 0
                };

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentStats = { ...currentStats, ...(userData.gameStats || {}) };
                }

                // ============= CALCUL DU SCORE AVEC P√âNALIT√â JUSTE =============
                const calculatedScore = calculateUniversalFairScore(gameData);

                // ============= MISE √Ä JOUR DU SCORE MOYEN POND√âR√â =============
                const alpha = 0.3; // Coefficient de pond√©ration
                const previousAverage = currentStats.averageScore || gameData.initialScore;
                const newAverageScore = Math.round(
                    (alpha * calculatedScore) + ((1 - alpha) * previousAverage)
                );

                // ============= MISE √Ä JOUR DES AUTRES STATISTIQUES =============
                const isWin = gameData.isCompleted && gameData.performance >= 50;
                const newTotalGames = currentStats.totalGamesPlayed + 1;
                const newTotalWins = currentStats.totalGamesWon + (isWin ? 1 : 0);
                const newTotalTime = currentStats.totalTimeSpent + gameData.time;
                const newAverageTime = Math.round(newTotalTime / newTotalGames);

                // ‚ö° NOUVEAU : Mettre √† jour le compteur de mode pour practice ET ranked
                const newPracticeGames = gameData.gameMode === 'practice' ? 
                    (currentStats.practiceGames || 0) + 1 : (currentStats.practiceGames || 0);
                const newRankedGames = gameData.gameMode === 'ranked' ? 
                    (currentStats.rankedGames || 0) + 1 : (currentStats.rankedGames || 0);

                // ‚ö° NOUVEAU : Compteurs par type de fin
                const newGamesCompleted = gameData.isCompleted ? 
                    (currentStats.gamesCompleted || 0) + 1 : (currentStats.gamesCompleted || 0);
                const newGamesAbandoned = gameData.isAbandoned ? 
                    (currentStats.gamesAbandoned || 0) + 1 : (currentStats.gamesAbandoned || 0);
                const newGamesDefeated = gameData.isDefeated ? 
                    (currentStats.gamesDefeated || 0) + 1 : (currentStats.gamesDefeated || 0);

                // Mettre √† jour le meilleur score pour cette difficult√© (seulement si gagn√©)
                const currentBest = currentStats.bestScores?.[gameData.difficulty] || 0;
                const newBestScores = { ...currentStats.bestScores };
                if (gameData.isCompleted && gameData.finalScore > currentBest) {
                    newBestScores[gameData.difficulty] = gameData.finalScore;
                }

                // Calculer le niveau bas√© sur les parties ranked gagn√©es
                const newLevel = calculateUniversalPlayerLevel(newRankedGames, newTotalWins, gameData.gameMode === 'ranked' && isWin);

                // Calculer la performance actuelle (bas√©e sur le score moyen vs score initial moyen)
                let newPerformance = currentStats.currentPerformance || 0;
                if (gameData.gameMode === 'ranked') {
                    // Performance bas√©e sur le score moyen par rapport au score initial moyen
                    const averageInitialScore = getUniversalAverageInitialScore();
                    newPerformance = Math.round(((newAverageScore / averageInitialScore) * 100) * 100) / 100;
                }

                // ============= METTRE √Ä JOUR LA BASE DE DONN√âES =============
                const updatedStats = {
                    totalGamesPlayed: newTotalGames,
                    totalGamesWon: newTotalWins,
                    totalTimeSpent: newTotalTime,
                    averageTime: newAverageTime,
                    averageScore: newAverageScore,
                    bestScores: newBestScores,
                    practiceGames: newPracticeGames,
                    rankedGames: newRankedGames,
                    level: newLevel,
                    currentPerformance: Math.max(0, Math.min(100, newPerformance)),
                    lastPlayed: new Date(),
                    // ‚ö° NOUVEAU : Compteurs par type de fin
                    gamesCompleted: newGamesCompleted,
                    gamesAbandoned: newGamesAbandoned,
                    gamesDefeated: newGamesDefeated
                };

                await updateDoc(userRef, {
                    gameStats: updatedStats
                }, { merge: true });

                console.log('‚úÖ Universal player stats updated successfully:', {
                    totalGames: newTotalGames,
                    practiceGames: newPracticeGames,
                    rankedGames: newRankedGames,
                    averageScore: newAverageScore,
                    calculatedScore: calculatedScore,
                    finalScore: gameData.finalScore,
                    level: newLevel,
                    endType: gameData.endType,
                    completed: newGamesCompleted,
                    abandoned: newGamesAbandoned,
                    defeated: newGamesDefeated
                });

            } catch (error) {
                console.error('‚ùå Error updating universal player stats:', error);
                throw error;
            }
        }

        // ============= CALCUL DU SCORE AVEC P√âNALIT√â JUSTE UNIVERSELLE =============
        function calculateUniversalFairScore(gameData) {
            const { finalScore, initialScore, isCompleted, isAbandoned, isDefeated, time, difficulty } = gameData;
            
            if (isCompleted) {
                // Partie termin√©e avec succ√®s : score r√©el
                return finalScore;
            }
            
            // ============= P√âNALIT√âS POUR PARTIES NON TERMIN√âES =============
            
            // 1. Base : score actuel au moment de l'arr√™t
            let penalizedScore = finalScore;
            
            if (isAbandoned) {
                // 2. P√©nalit√© de base pour abandon (20% du score initial)
                const abandonPenalty = Math.round(initialScore * 0.20);
                penalizedScore = Math.max(0, penalizedScore - abandonPenalty);
                
                // 3. P√©nalit√© proportionnelle au temps jou√©
                // Plus on abandonne t√¥t, plus la p√©nalit√© est forte
                const expectedMinTime = getUniversalDifficultyMinTime(difficulty);
                const timeRatio = Math.min(time / expectedMinTime, 1);
                const timePenalty = Math.round(initialScore * 0.15 * (1 - timeRatio));
                penalizedScore = Math.max(0, penalizedScore - timePenalty);
            }
            
            if (isDefeated) {
                // D√©faite (5 erreurs ou score = 0) : moins de p√©nalit√© car on a "essay√©"
                const defeatPenalty = Math.round(initialScore * 0.10);
                penalizedScore = Math.max(0, penalizedScore - defeatPenalty);
            }
            
            // 4. Score minimum garanti (10% du score initial)
            const minimumScore = Math.round(initialScore * 0.10);
            penalizedScore = Math.max(minimumScore, penalizedScore);
            
            return penalizedScore;
        }

        // Temps minimum attendu par difficult√© (en secondes)
        function getUniversalDifficultyMinTime(difficulty) {
            const minTimes = {
                'easy': 180,    // 3 minutes
                'medium': 300,  // 5 minutes  
                'hard': 450,    // 7.5 minutes
                'expert': 600,  // 10 minutes
                'master': 900   // 15 minutes
            };
            return minTimes[difficulty] || 300;
        }

        // Score initial moyen pour calculer la performance
        function getUniversalAverageInitialScore() {
            return (2000 + 4000 + 8000 + 15000 + 25000) / 5; // 10,800
        }

        // Fonction pour calculer le niveau du joueur (universelle)
        function calculateUniversalPlayerLevel(rankedGames, totalWins, isRankedWin) {
            if (rankedGames < 5) return 'Beginner';
            if (rankedGames < 10) return 'Novice';
            if (rankedGames < 25) return 'Intermediate';
            if (rankedGames < 50) return 'Advanced';
            if (rankedGames < 100) return 'Expert';
            if (rankedGames < 200) return 'Master';
            return 'Legend';
        }

        console.log('üî• Firebase initialized on main page with universal stats functions');
    </script>
    
    <link rel="stylesheet" href="style.css">
    
    <!-- Styles pour le header dynamique -->
    <style>
        /* ============= HEADER DYNAMIQUE - STYLES ============= */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-name {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-name:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: #2d3748;
        }

        .user-name::after {
            content: '‚ñº';
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .user-menu:hover .user-name::after {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid rgba(229, 229, 234, 0.3);
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .user-menu:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu a {
            display: block;
            padding: 14px 20px;
            color: #1c1c1e;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(229, 229, 234, 0.3);
        }

        .dropdown-menu a:last-child {
            border-bottom: none;
        }

        .dropdown-menu a:hover {
            background: rgba(0, 122, 255, 0.05);
            color: #007aff;
        }

        .dropdown-menu a:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .dropdown-menu a:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .user-flag {
            font-size: 16px;
            margin-right: 4px;
        }

        .signup-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46a3 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div class="main-content">
        <!-- Menu Mobile Overlay -->
        <div class="mobile-overlay" id="mobile-overlay"></div>

        <!-- Menu Mobile -->
        <div class="mobile-menu" id="mobile-menu">
            <div class="mobile-menu-header">
                <div class="mobile-logo">Suirodoku.com</div>
                <button class="mobile-close" id="mobile-close">√ó</button>
            </div>
            
            <div class="mobile-menu-content">
                <div class="mobile-nav-section">
                    <div class="mobile-section-title">Navigation</div>
                    <button class="mobile-nav-item" onclick="navigateTo('tutorial'); closeMobileMenu();">
                        How to Play
                    </button>
                    <button class="mobile-nav-item" onclick="navigateTo('leaderboard'); closeMobileMenu();">
                        Leaderboards
                    </button>
                </div>
                
                <div class="mobile-nav-section">
                    <div class="mobile-section-title">Game</div>
                    <button class="mobile-nav-item" onclick="showNewGameModal(); closeMobileMenu();">
                        New Game
                    </button>
                </div>
                
                <!-- Section Account - Dynamique selon l'√©tat de connexion -->
                <div class="mobile-nav-section" id="mobile-auth-section">
                    <div class="mobile-section-title">Account</div>
                    <!-- Contenu dynamique inject√© par JavaScript -->
                </div>
                
                <div class="mobile-nav-section">
                    <div class="mobile-section-title">Legal</div>
                    <button class="mobile-nav-item" onclick="navigateTo('legal'); closeMobileMenu();">
                        Privacy & Terms
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div class="error-modal" id="error-modal">
            <div class="error-icon">üîÑ</div>
            <div class="error-text">Oops! Try again!</div>
            <div class="error-subtext">Click "Correct" to clear the error and continue</div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo" onclick="goToHome()">Suirodoku.com</div>
            
            <!-- Navigation Menu (Desktop) -->
            <nav class="nav-menu">
                <button class="nav-btn" onclick="navigateTo('tutorial')">
                    How to Play
                </button>
                
                <button class="nav-btn" onclick="navigateTo('leaderboard')">
                    Leaderboards
                </button>
            </nav>
            
            <!-- Auth Buttons (Desktop) - Dynamique selon l'√©tat de connexion -->
            <div class="auth-buttons" id="desktop-auth-buttons">
                <!-- Contenu dynamique inject√© par JavaScript -->
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <div class="game-info-content">
                <!-- Stats du jeu (Desktop: inline, Mobile: dans .game-stats) -->
                <div class="game-stats">
                    <div class="info-item">
                        <div class="info-label">Score</div>
                        <div class="info-value score" id="score-display">2000</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Level</div>
                        <div class="info-value" id="difficulty-display">Easy</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Errors</div>
                        <div class="info-value" id="errors-count">0/5</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time</div>
                        <div class="info-value" id="game-time">00:00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Hint</div>
                        <div class="info-value hint-icon" style="color: #484848; font-size: 18px; cursor: pointer;" onclick="document.getElementById('hint-btn').click()">üí°</div>
                    </div>
                </div>

                <!-- Boutons d'action (Desktop: √† droite, Mobile: √† gauche) -->
                <div class="pause-container">
                    <!-- Bouton Hamburger Mobile - visible seulement sur mobile -->
                    <div class="mobile-hamburger" id="mobile-hamburger">
                        <div class="hamburger-line"></div>
                        <div class="hamburger-line"></div>
                        <div class="hamburger-line"></div>
                    </div>
                    <!-- Boutons dans l'ordre logique -->
                    <button class="solve-btn" id="correct-btn" title="Correct the error" style="display: none;">Correct</button>
                    <button class="solve-btn" id="reveal-btn" title="Complete the entire grid">Complete</button>
                    <div style="width: 1px; height: 20px; background-color: #e5e5ea; margin: 0 8px;"></div>
                    <button class="solve-btn" id="new-game-btn" title="Start a new game">New Game</button>
                </div>

                <div style="display: none;">
                    <button id="hint-btn" title="Hint for selected cell"></button>
                </div>
            </div>
        </div>

        <!-- Main Game Container -->
        <div class="game-container">
            <!-- Sudoku Grid -->
            <div class="sudoku-wrapper">
                <div class="sudoku-grid" id="sudoku-grid">
                    <!-- Les 81 cases seront g√©n√©r√©es par JavaScript -->
                </div>
            </div>

            <!-- Controls Panel (Desktop) -->
            <div class="controls-panel">
                <!-- Numbers Section -->
                <div class="control-section">
                    <div class="control-header">
                        <span class="control-title">NUMBERS</span>
                        <button class="notes-toggle" id="notes-toggle-numbers"><span class="pencil-icon">‚úèÔ∏è</span></button>
                    </div>
                    <div class="number-grid">
                        <button class="number-btn" data-number="1">1</button>
                        <button class="number-btn" data-number="2">2</button>
                        <button class="number-btn" data-number="3">3</button>
                        <button class="number-btn" data-number="4">4</button>
                        <button class="number-btn" data-number="5">5</button>
                        <button class="number-btn" data-number="6">6</button>
                        <button class="number-btn" data-number="7">7</button>
                        <button class="number-btn" data-number="8">8</button>
                        <button class="number-btn" data-number="9">9</button>
                    </div>
                </div>

                <!-- Colors Section -->
                <div class="control-section">
                    <div class="control-header">
                        <span class="control-title">COLORS</span>
                        <button class="notes-toggle" id="notes-toggle-colors-mobile"><span class="pencil-icon">‚úèÔ∏è</span></button>
                    </div>
                    <div class="color-grid">
                        <button class="color-btn color-yellow" data-color="J"></button>
                        <button class="color-btn color-orange" data-color="O"></button>
                        <button class="color-btn color-red" data-color="R"></button>
                        <button class="color-btn color-green" data-color="G"></button>
                        <button class="color-btn color-brown" data-color="P"></button>
                        <button class="color-btn color-pink" data-color="M"></button>
                        <button class="color-btn color-cyan" data-color="T"></button>
                        <button class="color-btn color-blue" data-color="B"></button>
                        <button class="color-btn color-purple" data-color="V"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Difficulty Selection Modal -->
        <div class="modal-overlay" id="difficulty-modal">
            <div class="difficulty-modal">
                <div class="modal-title">Choose difficulty</div>
                <div class="modal-subtitle">Select your challenge level</div>
                
                <div class="difficulty-grid">
                    <div class="difficulty-option" data-difficulty="easy">
                        <div class="difficulty-name">üü¢ Easy</div>
                        <div class="difficulty-details">Perfect for beginners</div>
                        <div class="difficulty-stats">
                            <span>74 hints ‚Ä¢ 2,000 pts</span>
                            <span>üíî 300 üí° 150 ‚è±Ô∏è 1/s</span>
                        </div>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="medium">
                        <div class="difficulty-name">üü° Medium</div>
                        <div class="difficulty-details">A bit more challenging</div>
                        <div class="difficulty-stats">
                            <span>68 hints ‚Ä¢ 4,000 pts</span>
                            <span>üíî 500 üí° 250 ‚è±Ô∏è 2/s</span>
                        </div>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="hard">
                        <div class="difficulty-name">üü† Hard</div>
                        <div class="difficulty-details">For experienced players</div>
                        <div class="difficulty-stats">
                            <span>60 hints ‚Ä¢ 8,000 pts</span>
                            <span>üíî 800 üí° 400 ‚è±Ô∏è 3/s</span>
                        </div>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="expert">
                        <div class="difficulty-name">üî¥ Expert</div>
                        <div class="difficulty-details">Very challenging</div>
                        <div class="difficulty-stats">
                            <span>52 hints ‚Ä¢ 15,000 pts</span>
                            <span>üíî 1.2K üí° 600 ‚è±Ô∏è 4/s</span>
                        </div>
                    </div>
                    
                    <div class="difficulty-option" data-difficulty="master">
                        <div class="difficulty-name">‚ö´ Master</div>
                        <div class="difficulty-details">For true experts only</div>
                        <div class="difficulty-stats">
                            <span>44 hints ‚Ä¢ 25,000 pts</span>
                            <span>üíî 2K üí° 1K ‚è±Ô∏è 6/s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ö° NOUVEAU : Victory Modal Am√©lior√© -->
        <div class="modal-overlay" id="victory-modal">
            <div class="victory-modal">
                <div class="victory-icon">üèÜ</div>
                <div class="victory-title">Congratulations!</div>
                <div class="victory-subtitle">You completed the puzzle!</div>
                
                <div class="victory-stats">
                    <div class="victory-stat">
                        <div class="stat-label">Final Score</div>
                        <div class="stat-value" id="final-score">2,000</div>
                    </div>
                    <div class="victory-stat">
                        <div class="stat-label">Time</div>
                        <div class="stat-value" id="final-time">05:42</div>
                    </div>
                    <div class="victory-stat">
                        <div class="stat-label">Difficulty</div>
                        <div class="stat-value" id="final-difficulty">Easy</div>
                    </div>
                    <div class="victory-stat">
                        <div class="stat-label">Errors</div>
                        <div class="stat-value" id="final-errors">2/5</div>
                    </div>
                    <!-- Mode et sauvegarde ajout√©s dynamiquement par JavaScript -->
                </div>
                
                <div class="victory-buttons">
                    <button class="victory-btn primary" id="victory-new-game">New Game</button>
                    <button class="victory-btn secondary" id="victory-close">Close</button>
                </div>
            </div>
        </div>

        <!-- ‚ö° NOUVEAU : Defeat Modal (cr√©√© dynamiquement par JavaScript) -->
        <!-- Le modal de d√©faite sera cr√©√© par script.js lors du premier appel √† showDefeatModal() -->

        <!-- ‚ö° NOUVEAU : Mode Selection Modal (cr√©√© dynamiquement par JavaScript) -->
        <!-- Le modal de s√©lection de mode sera cr√©√© par script.js lors de l'appel √† showNewGameModal() -->
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-tab"></div>
        <div class="footer-content">
            <div class="footer-bottom">
                <div class="footer-copyright">
                    ¬© 2024 Suirodoku.com. All rights reserved.
                </div>
                <div class="footer-legal">
                    <a onclick="navigateTo('legal')">Privacy Policy</a>
                    <a onclick="navigateTo('legal')">Terms of Service</a>
                    <a onclick="navigateTo('legal')">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    
    <!-- Script pour gestion dynamique du header -->
    <script>
        // ============= GESTION DYNAMIQUE DU HEADER =============
        
        async function updateHeaderAuthState(user) {
            const desktopAuthButtons = document.getElementById('desktop-auth-buttons');
            const mobileAuthSection = document.getElementById('mobile-auth-section');
            
            if (user && desktopAuthButtons) {
                // R√©cup√©rer les donn√©es utilisateur compl√®tes
                const userData = await getUserData(user);
                
                // Utilisateur connect√© - Afficher menu utilisateur
                const displayName = getDisplayName(userData);
                const flag = userData.profile?.nationality ? getFlagEmoji(userData.profile.nationality) : '';
                
                desktopAuthButtons.innerHTML = `
                    <div class="user-menu">
                        <div class="user-name">
                            <span class="user-flag">${flag}</span>
                            <span>${displayName}</span>
                        </div>
                        <div class="dropdown-menu">
                            <a href="./profile/">üë§ My Profile</a>
                            <a href="./stats/">üìä My Statistics</a>
                            <a href="./settings/">‚öôÔ∏è Settings</a>
                            <a href="#" onclick="signOutUser()">üö™ Sign Out</a>
                        </div>
                    </div>
                `;
                
                // Menu mobile
                if (mobileAuthSection) {
                    mobileAuthSection.innerHTML = `
                        <div class="mobile-section-title">Account</div>
                        <button class="mobile-nav-item" onclick="navigateTo('profile'); closeMobileMenu();">
                            <span style="margin-right: 12px;">üë§</span>
                            My Profile
                        </button>
                        <button class="mobile-nav-item" onclick="navigateTo('stats'); closeMobileMenu();">
                            <span style="margin-right: 12px;">üìä</span>
                            My Statistics
                        </button>
                        <button class="mobile-nav-item" onclick="navigateTo('settings'); closeMobileMenu();">
                            <span style="margin-right: 12px;">‚öôÔ∏è</span>
                            Settings
                        </button>
                        <button class="mobile-nav-item" onclick="signOutUser(); closeMobileMenu();">
                            <span style="margin-right: 12px;">üö™</span>
                            Sign Out
                        </button>
                    `;
                }
            } else if (desktopAuthButtons) {
                // Utilisateur non connect√© - Afficher bouton Login
                desktopAuthButtons.innerHTML = `
                    <button class="auth-btn login-btn" onclick="navigateTo('auth')">Log In</button>
                `;
                
                if (mobileAuthSection) {
                    mobileAuthSection.innerHTML = `
                        <div class="mobile-section-title">Account</div>
                        <button class="mobile-nav-item" onclick="navigateTo('auth'); closeMobileMenu();">
                            Log In
                        </button>
                    `;
                }
            }
        }
        
        // Fonction de d√©connexion
        window.signOutUser = async function() {
            try {
                const { auth, signOut } = window.firebaseAuth;
                await signOut(auth);
                console.log('‚úÖ User signed out successfully');
                
                // Mettre √† jour l'interface imm√©diatement
                updateHeaderAuthState(null);
                
                // Optionnel: rafra√Æchir la page
                // window.location.reload();
            } catch (error) {
                console.error('‚ùå Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        };
        
        // √âcouter les changements d'√©tat d'authentification
        function initializeHeaderAuth() {
            // V√©rifier si Firebase est disponible
            if (typeof window.firebaseAuth !== 'undefined') {
                const { auth, onAuthStateChanged } = window.firebaseAuth;
                
                onAuthStateChanged(auth, (user) => {
                    updateHeaderAuthState(user);
                });
            } else {
                // Firebase pas encore charg√©, r√©essayer
                setTimeout(initializeHeaderAuth, 100);
            }
        }
        
        // Initialiser au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Afficher l'√©tat par d√©faut (non connect√©)
            updateHeaderAuthState(null);
            
            // Puis initialiser l'√©coute Firebase
            initializeHeaderAuth();
        });
        
        // Fonction navigateTo pour toutes les pages
        function navigateTo(page) {
            switch(page) {
                case 'profile':
                    window.location.href = './profile/';
                    break;
                case 'stats':
                    window.location.href = './stats/';
                    break;
                case 'settings':
                    window.location.href = './settings/';
                    break;
                case 'auth':
                    window.location.href = './auth/';
                    break;
                case 'tutorial':
                    window.location.href = './tutorial/';
                    break;
                case 'leaderboard':
                    window.location.href = './leaderboard/';
                    break;
                case 'legal':
                    window.location.href = './legal/';
                    break;
                default:
                    console.log('Navigate to:', page);
            }
        }
        
        function goToHome() {
            window.location.href = './';
        }
    </script>
</body>
</html><button class="number-btn" data-number="7">7</button>
                        <button class="number-btn" data-number="8">8</button>
                        <button class="number-btn" data-number="9">9</button>
                    </div>
                </div>

                <!-- Colors Section -->
                <div class="control-section" style="margin-top: 10px;">
                    <div class="control-header">
                        <span class="control-title">COLORS</span>
                        <button class="notes-toggle" id="notes-toggle-colors"><span class="pencil-icon">‚úèÔ∏è</span></button>
                    </div>
                    <div class="color-grid">
                        <button class="color-btn color-yellow" data-color="J"></button>
                        <button class="color-btn color-orange" data-color="O"></button>
                        <button class="color-btn color-red" data-color="R"></button>
                        <button class="color-btn color-green" data-color="G"></button>
                        <button class="color-btn color-brown" data-color="P"></button>
                        <button class="color-btn color-pink" data-color="M"></button>
                        <button class="color-btn color-cyan" data-color="T"></button>
                        <button class="color-btn color-blue" data-color="B"></button>
                        <button class="color-btn color-purple" data-color="V"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Controls (Mobile) -->
        <div class="bottom-controls">
            <div class="bottom-row">
                <!-- Numbers Section -->
                <div class="control-section">
                    <div class="control-header">
                        <span class="control-title">NUMBERS</span>
                        <button class="notes-toggle" id="notes-toggle-numbers-mobile"><span class="pencil-icon">‚úèÔ∏è</span></button>
                    </div>
                    <div class="number-grid">
                        <button class="number-btn" data-number="1">1</button>
                        <button class="number-btn" data-number="2">2</button>
                        <button class="number-btn" data-number="3">3</button>
                        <button class="number-btn" data-number="4">4</button>
                        <button class="number-btn" data-number="5">5</button>
                        <button class="number-btn" data-number="6">6</button>
